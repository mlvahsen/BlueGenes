---
title: "Blue Genes Analysis"
author: "Megan Vahsen"
date: "10/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE, warning = FALSE, results=FALSE}
# Read in libraries 
library(here); library(tidyverse); library(emmeans);
library(lme4); library(lmerTest); library(kableExtra);
library(car); library(sjPlot); library(MuMIn); library(EnvStats);
library(merTools); library(patchwork); library(RColorBrewer)

# Read in compiled trait data
source(here("supp_code", "CompileTraitData.R"))
```

# Data Subsetting

For most analyses we are going to need to subset the data into the competition data set (all Corn Island -- these were the only genotypes that had competition; and the no competition pots). For the no competition pots, we are also dropping out the Blackwater genotypes because they can't really be separated into age and location cohorts. We are also going to focus in on levels 1-4 where most clones survived.

## Calculate the overall survival rate by flooding level

```{r, message = F, echo = F}
bg_full %>% 
  group_by(level) %>% 
  summarize(n = n(),
            extinct = sum(extinct),
            survival = paste(round((n - extinct)*100 / n,1), "%", sep = "")) %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)
```

## Summarizing by cohort and genotype for the all Corn Island dataset

```{r, message = F, echo = F}
bg_corn <- bg_full %>% filter(location == "corn" & level < 5)

bg_corn %>% 
  group_by(age, location) %>% 
  summarize(n = n()) %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)

bg_corn %>% 
  group_by(genotype) %>% 
  summarize(n = n()) %>% 
  arrange(n) %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)
```

## Summarizing by cohort and genotype for the no competition dataset

```{r, message = F, echo = F}
bg_nocomp <- bg_full %>% filter(comp == 0 & location != "blackwater" & level < 5)

bg_nocomp %>% 
  group_by(age, location) %>% 
  summarize(n = n()) %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)

bg_nocomp %>% 
  group_by(genotype) %>% 
  summarize(n = n()) %>% 
  arrange(n) %>%  
  knitr::kable() %>% 
  kable_styling(full_width = F)

```

# Trait analysis for no competition pots

For the overall trait analysis, we are going to do two separate analyses, one for each data set. Because there are so many potential interactions between factors (environmental or genetic), we will use a backward selection model approach to see what *interactions* are important in explaining variation in the data. Here is the general approach:

* Fit the most complex model with respect to fixed effects 
    + 5-way interaction between $\text{CO}_2$ (2 levels: ambient, elevated), salinity (2 levels: GCREW, freshwater), elevation (continuous), age cohort (2 levels: ancestral, descendant), and provenance (2 levels: Kirkpatrick Marsh, Corn Island)
    + quadratic term for elevation (no interactions)
    + initial weight of the propagule, temporal planting group (2 levels: late June, early July), lab of origin (2 levels: ND, UTK)
* In this model also include random intercepts for genotype and for chamber
    + For some models, the variance explained by chamber is basically zero and can be dropped from the model
* Use `lmerTest::step` for perform backwards stepwise selection on the fixed effects of that model
    + Use the argument `keep` to force the stepwise selection procedure to keep the additive fixed effects of $\text{CO}_2$, salinity, elevation, age cohort, and provenance because these are things that we purposefully manipulated
    + This means that the only terms that can be dropped are interactions and covariates related to the experimental set-up such as initial weight of the propagule
* Given the final model, then test to see if there are genotype by environment interactions that can explain significantly more variation
    + Do this by fitting models with random slopes using terms (up to two-way interactions) that were kept in the model for $\text{CO}_2$, salinity, and elevation
    + Test to see if the genotype by environment should be kept using a significance test with `anova()` while setting the argument `refit = FALSE` to fit models using restricted maximum likelihood for these comparsions

## Aboveground biomass
```{r, fig.align='center'}
# Center and scale continuous variables and subset to just aboveground biomass
# greater than 0
bg_nocomp %>% 
  mutate(elevation_sc = scale(elevation)[,1],
         weight_init_sc = scale(weight_init)[,1]) %>% 
  filter(extinct == 0)-> bg_nocomp

# Fit the most complex model -- sqrt of agb biomass seems like the best
# transformation
agb_mod <- lmer(sqrt(agb_scam) ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|site_frame) + (1|genotype), data = bg_nocomp)

# Warning indicates that one of the random intercepts is estimated to be zero
VarCorr(agb_mod) # It's chamber, so we'll drop it

# Fit a model without that term
agb_mod2 <- update(agb_mod, .~.-(1|site_frame))

# Do a stepwise model selection
# step(agb_mod2, keep = c("co2", "elevation_sc", "salinity", "age", "location"))

# There's a model fitting issue because the model is too complicated. Let's see
# if there's a significant 5-way interaction
Anova(agb_mod2)
# Nope! Drop it and try stepwise again
agb_mod3 <- lmer(sqrt(agb_scam) ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^4 + I(elevation_sc^2) +
                  (1|genotype), data = bg_nocomp)

step(agb_mod3, keep = c("co2", "elevation_sc", "salinity", "age", "location"))

# Fit the proposed stepwise model
agb_mod4 <- lmer(sqrt(agb_scam) ~ weight_init + I(elevation^2) + location +
    age*co2*salinity*elevation + (1 | genotype), data = bg_nocomp)

# See if there are random effects models that are an improvement of this model
agb_mod5 <- update(agb_mod4, .~.-(1|genotype) + (co2*elevation_sc|genotype))
agb_mod6 <- update(agb_mod4, .~.-(1|genotype) + (co2*salinity|genotype))
agb_mod7 <- update(agb_mod4, .~.-(1|genotype) + (salinity*elevation_sc|genotype))
agb_mod8 <- update(agb_mod4, .~.-(1|genotype) + (co2+elevation_sc|genotype))
agb_mod9 <- update(agb_mod4, .~.-(1|genotype) + (co2+salinity|genotype))
agb_mod10 <- update(agb_mod4, .~.-(1|genotype) + (salinity+elevation_sc|genotype))
agb_mod11 <- update(agb_mod4, .~.-(1|genotype) + (co2|genotype)) 
agb_mod12 <- update(agb_mod4, .~.-(1|genotype) + (salinity|genotype))
agb_mod13 <- update(agb_mod4, .~.-(1|genotype) + (elevation_sc|genotype))

# So final model is the same as the stepwise proposed model
agb_final <- agb_mod4

```

```{r}
# Look at model diagnostics
plot_model(agb_final, type = "diag")

# Look at random effects
plot_model(agb_final, type = "re")

# Refit model and get Type 3 Anova table
Anova(agb_final, type = 3)
```

```{r}
# Extract predicted means for model
agb_means <- emmeans::emmeans(agb_final, ~co2:salinity:age:elevation, at= list(elevation = seq(0.15, 0.55, 0.01)), type = "response")

agb_means_out <- summary(agb_means)
agb_means_out %>% 
  mutate(salinity = case_when(salinity == "fresh" ~ "Freshwater Site (6ppt)",
                              T ~ "Brackish Site (8ppt)"),
         age = case_when(age == "modern" ~ "Descendant cohort (2000-2020)",
                         T ~ "Ancestral cohort (1900-1960)")) -> agb_means_out

bg_nocomp_plot <- bg_nocomp %>% 
  mutate(salinity = case_when(salinity == "fresh" ~ "Freshwater Site (6ppt)",
                              T ~ "Brackish Site (8ppt)"),
         age = case_when(age == "modern" ~ "Descendant cohort (2000-2020)",
                         T ~ "Ancestral cohort (1900-1960)"))


agb_means_out %>% 
  ggplot(aes(x = elevation, y = response, color = co2)) + 
  geom_line(size = 1.5) +
  #geom_line(aes(x = elevation, y = lower.CL), linetype = "dashed") + 
  #geom_line(aes(x = elevation, y = upper.CL), linetype = "dashed") + 
  facet_grid(age~salinity) +
  geom_point(data = bg_nocomp_plot, aes(x = elevation, y = agb_scam), alpha = 0.5) +
  theme_bw() +
  scale_color_manual(values = c("gray47", "#66a61e")) +
  ylab("Aboveground biomass (g)") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend(title=expression(CO[2]))) +
  theme(legend.position = "top")-> a
```

```{r}
# Comparison to a null model that does not include age, location or genotype
agb_null <- lm(sqrt(agb_scam) ~ weight_init_sc +
                  (co2 + salinity + elevation_sc)^3 + I(elevation_sc^2), data = bg_nocomp)

# Get R2 from model
agb_null_r2 <- r.squaredGLMM(agb_null)[2]

# Compare to conditional R2 from full model
agb_r2 <- r.squaredGLMM(agb_final)[2]

# Create enough colors for each genotype to have one
n <- length(unique(bg_nocomp$genotype))
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

# Create caterpillar graph
REsim(agb_final) %>%
  mutate(groupID = fct_reorder(groupID, mean)) %>% 
  ggplot(aes(x = groupID)) +
  geom_pointrange(aes(ymin = mean - 2*sd, ymax = mean + 2*sd, xmin = groupID, xmax = groupID, y = mean, color = groupID)) +
  coord_flip() +
  ylab("Random effect") +
  xlab("Genotype") +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() + scale_x_discrete(position = "top")  +
  scale_color_manual(values = col_vector) +
  theme(legend.position = "none")-> b
  #theme(axis.text.y=element_blank(),
        #axis.ticks.y = element_blank()) -> b


cowplot::plot_grid(a,b, rel_widths = c(4,1)) -> agb_plot

```

## Root:shoot ratio

```{r}
# Calculate root-to-shoot ratio on no comp pots
bg_nocomp %>% 
  mutate(rs = total_bg / agb_scam) -> bg_nocomp

# Plot and see if there are outliers
bg_nocomp %>% 
  ggplot(aes(x = rs)) +
  geom_histogram() +
  geom_rug() +
  xlab("root-to-shoot ratio")

# There are two pots that have really high r:s and one that seems a bit high.
# Take a look at these further.
bg_nocomp %>% 
  filter(rs > 4.5)
# It seems like pot_no 98 is real -- just a lot of bg compared to ag (on level
# 1)

# The other two seem to be more of experimental artifacts (i.e. initial
# propagule weight is driving total belowground weight at the end), so we drop
# those two

bg_nocomp %>% 
  filter(rs < 6) -> bg_nocomp_rs

# There also appear to be some that are NAs
bg_nocomp %>% 
  filter(!complete.cases(rs))
# Need to figure this out on data checking!!! I think these were pots with
# messed up bg processing. Move forward with this for now, but I'll go back and
# fix these later

# Change names of salinity factor for presentation
bg_nocomp_rs %>% 
  mutate(salinity = case_when(salinity == "fresh" ~ "Freshwater Site (6ppt)",
                              T ~ "Brackish Site (8ppt)")) -> bg_nocomp_rs

# Scale elevation
bg_nocomp_rs$elevation_sc <- scale(bg_nocomp_rs$elevation)[,1]
centering <- attr(scale(bg_nocomp_rs$elevation), "scaled:center")
scaling <- attr(scale(bg_nocomp_rs$elevation), "scaled:scale")

## Fit model and model selection (fixed effects) ####

# Most complex model -- log is the best transformation
rs_mod <- lmer(log(rs) ~ weight_init + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation)^5 + I(elevation^2) +
                  + (1|site_frame) + (1|genotype), data = bg_nocomp_rs)

# Do stepwise model selection
# step(rs_mod, keep = c("co2", "salinity", "elevation", "age", "location"))

# Error because model is too complex -- Try with just 4-way interactions
# Most complex model -- log is the best transformation
rs_mod2 <- lmer(log(rs) ~ weight_init + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation)^4 + I(elevation^2) +
                  + (1|site_frame) + (1|genotype), data = bg_nocomp_rs)

# Do stepwise model selection
# step(rs_mod2, keep = c("co2", "salinity", "elevation", "age", "location")) # Still mad

Anova(rs_mod2) # Could drop down to 3-way interactions

rs_mod3 <- lmer(log(rs) ~ weight_init + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation)^3 + I(elevation^2) +
                  + (1|site_frame) + (1|genotype), data = bg_nocomp_rs)

step(rs_mod3, keep = c("co2", "salinity", "elevation", "age", "location"))

# Create the stepwise model
rs_mod4 <- lmer(log(rs) ~ location*elevation + salinity*elevation + age*co2*elevation+
                 (1|genotype), data = bg_nocomp_rs)

# Diagnostic plots
plot_model(rs_mod4, type = "diag")

# See if there are random effects models that are an improvement of this model
rs_mod5 <- update(rs_mod4, .~.-(1|genotype) + (co2*elevation|genotype))
rs_mod6 <- update(rs_mod4, .~.-(1|genotype) + (co2*salinity|genotype))
rs_mod7 <- update(rs_mod4, .~.-(1|genotype) + (salinity*elevation|genotype)) # fits
rs_mod8 <- update(rs_mod4, .~.-(1|genotype) + (co2+elevation|genotype))
rs_mod9 <- update(rs_mod4, .~.-(1|genotype) + (co2+salinity|genotype))
rs_mod10 <- update(rs_mod4, .~.-(1|genotype) + (salinity+elevation|genotype)) # fits
rs_mod11 <- update(rs_mod4, .~.-(1|genotype) + (co2|genotype)) 
rs_mod12 <- update(rs_mod4, .~.-(1|genotype) + (salinity|genotype)) # fits 
rs_mod13 <- update(rs_mod4, .~.-(1|genotype) + (elevation|genotype)) # fits

anova(rs_mod4, rs_mod7, refit = F) # ns
anova(rs_mod4, rs_mod10, refit = F) # ns
anova(rs_mod4, rs_mod12, refit = F) # ns
anova(rs_mod4, rs_mod13, refit = F) # ns

# None of the random effects add significantly

# Create caterpillar graph
REsim(rs_mod4) %>%
  mutate(groupID = fct_reorder(groupID, mean)) %>% 
  ggplot(aes(x = groupID)) +
  geom_pointrange(aes(ymin = mean - 2*sd, ymax = mean + 2*sd, xmin = groupID, xmax = groupID, y = mean, color = groupID)) +
  coord_flip() +
  ylab("Random effect") +
  xlab("Genotype") +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() + scale_x_discrete(position = "top") +
  theme(legend.position = "none") +
  scale_color_manual(values = col_vector)-> d

# Also fit a null model
rs_mod_null <- lm(log(rs) ~ elevation*salinity + co2*elevation, data = bg_nocomp_rs)

# Compare R2 values
rs_null_r2 <- r.squaredGLMM(rs_mod_null)[2]
rs_r2 <- r.squaredGLMM(rs_mod4)[2]

# Make plots of fixed effects
Anova(rs_mod4, type = 3)
# Need elevation:age:co2, elevation:salinity, and location:elevation

# Extract predicted means for model
rs_means <- emmeans::emmeans(rs_mod4, ~co2:age:elevation,
                             at= list(elevation = seq(0.15, 0.55, 0.01)), type = "response")

rs_means_out <- summary(rs_means)

rs_means_out %>% 
  mutate(age = case_when(age == "modern" ~ "Descendant cohort (2000-2020)",
                         T ~ "Ancestral cohort (1900-1960)")) -> rs_means_out

bg_nocomp_rs_plot <- bg_nocomp_plot %>% 
  mutate(rs = total_bg / agb_scam) %>% 
  filter(rs < 5)

rs_means_out %>% 
  ggplot(aes(x = elevation, y = response, color = co2)) + 
  geom_line(size = 1.5) +
  facet_wrap(~age) +
  geom_point(data = bg_nocomp_rs_plot, aes(x = elevation, y = rs), alpha = 0.5) +
  theme_bw() +
  scale_color_manual(values = c("gray47", "#66a61e")) +
  ylab("Root-to-shoot ratio") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend(title=expression(CO[2]))) +
  theme(legend.position = "top") -> e

rs_means2 <- emmeans(rs_mod4, ~salinity:elevation,
                    at= list(elevation = seq(0.15, 0.55, 0.01)), type = "response")

rs_means_out2 <- summary(rs_means2)

rs_means_out2 %>% 
  ggplot(aes(x = elevation, y = response, color = salinity)) +
  geom_line(size = 1.5) +
  geom_point(data = bg_nocomp_rs_plot, aes(x = elevation, y = rs), alpha = 0.5) +
  theme_bw() + scale_color_manual(values = c("orange", "gray47")) +
  ylab("Root-to-shoot ratio") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend("")) +
  theme(legend.position = "top") -> f

rs_means3 <- emmeans(rs_mod4, ~location:elevation,
                    at= list(elevation = seq(0.15, 0.55, 0.01)), type = "response")

rs_means_out3 <- summary(rs_means3)

rs_means_out3 %>% 
  mutate(location = case_when(location == "corn" ~ "Corn Island",
                              T ~ "Kirkpatrick Marsh")) -> rs_means_out3

bg_nocomp_rs_plot %>% 
  mutate(location = case_when(location == "corn" ~ "Corn Island",
                              T ~ "Kirkpatrick Marsh")) -> bg_nocomp_rs_plot

rs_means_out3 %>% 
  ggplot(aes(x = elevation, y = response, color = location)) +
  geom_line(size = 1.5) +
  geom_point(data = bg_nocomp_rs_plot, aes(x = elevation, y = rs), alpha = 0.5) +
  theme_bw() + scale_color_manual(values = c("#1b9e77", "#7570b3")) +
  ylab("Root-to-shoot ratio") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend("")) +
  theme(legend.position = "top") -> g

cowplot::plot_grid(f, g, labels = c("b", "c")) -> fg
cowplot::plot_grid(e, fg, ncol = 1, labels = c("a", "", "")) -> fge
cowplot::plot_grid(d, labels = "d") -> d
fge + d + plot_layout(widths = c(4,1), guides = "collect") -> rs_plot

```

## Root distribution parameter

```{r}
# Most complex model
beta_mod <- lmer(beta ~ weight_init + date_planted_grp + origin_lab +
                 (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                 (1|site_frame) + (1|genotype), data = bg_nocomp_rs)

# Do stepwise model selection
# step(beta_mod) # too complex

VarCorr(beta_mod)
Anova(beta_mod)

# site_frame variance is low and no significant 5-way and 4-way interactions
beta_mod2 <- update(beta_mod, .~.-(1|site_frame))
# step(beta_mod2)

beta_mod3 <- lmer(beta ~ weight_init + date_planted_grp + origin_lab +
                 (age + location + co2 + salinity + elevation_sc)^4 + I(elevation_sc^2) +
                 (1|genotype), data = bg_nocomp_rs)

step(beta_mod3, keep = c("co2", "salinity", "elevation_sc", "age", "location"))

# Create stepwise model
beta_mod4 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 | genotype), data = bg_nocomp_rs)

# Check diagnostics
plot_model(beta_mod4, type = "diag") 
# Some evidence of non-normality, but not horrible

# See if there are significant random intercepts
beta_mod5 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + salinity*elevation_sc| genotype), data = bg_nocomp_rs) # fits
beta_mod6 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + salinity+elevation_sc| genotype), data = bg_nocomp_rs) # fits
beta_mod7 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + salinity+co2| genotype), data = bg_nocomp_rs)
beta_mod8 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + elevation_sc+co2| genotype), data = bg_nocomp_rs)
beta_mod9 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + co2| genotype), data = bg_nocomp_rs)
beta_mod10 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + salinity| genotype), data = bg_nocomp_rs) # fits
beta_mod11 <- lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + elevation_sc| genotype), data = bg_nocomp_rs) # fits

anova(beta_mod5, beta_mod4) # *** best model
anova(beta_mod6, beta_mod5) # ***
anova(beta_mod10, beta_mod4) # *
anova(beta_mod11, beta_mod4) # **

# Best model has salinity*elevation random slope
beta_finalmod <-lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + salinity*elevation_sc| genotype), data = bg_nocomp_rs)

# Look at random effect
out <- plot_model(beta_finalmod, type = "pred", pred.type = "re", terms = c("elevation_sc[all]", "genotype","salinity")) +
  scale_color_manual(values = rainbow(31)) +
  ggtitle("") +
  theme_bw() +
  theme(legend.position = "none") +
  ylab("Root distribution parameter") +
  xlab("Elevation (m NAVD88)") 


# Extract values from plot_model so we can customize
tibble(elevation_sc = out$data$x,
       root_param = out$data$predicted,
       genotype = out$data$group,
       salinity = out$data$facet) %>% 
  mutate(elevation = elevation_sc*scaling + centering) -> beta_GxE_data

beta_GxE_data %>% 
  filter(elevation %in% min(elevation)) -> mins

beta_GxE_data %>% 
  filter(elevation %in% max(elevation)) -> maxs

# Make random effects plot
beta_GxE_data %>% 
  ggplot(aes(x = elevation, y = root_param, color = genotype)) +
  geom_line(size = 1, alpha = 1) +
  facet_wrap(~salinity) +
  scale_color_manual(values = col_vector) +
  theme_bw() +
  theme(legend.position = "none") +
  ylab("Root distribution parameter") +
  xlab("Elevation (m NAVD88)") +
  geom_point(data = mins, aes(x = elevation, y = root_param, color = genotype), size = 2.7) +
  geom_point(data = maxs, aes(x = elevation, y = root_param, color = genotype), size = 2.7) -> h
 

# Make fixed effect plot
beta_means <- emmeans(beta_finalmod, ~salinity:elevation_sc,
                    at= list(elevation_sc = seq(-1.72, 1.54, 0.1)), type = "response")

beta_means_out <- summary(beta_means)

beta_means_out %>% 
  mutate(elevation = elevation_sc*scaling + centering) %>% 
  ggplot(aes(x = elevation, y = emmean, color = salinity)) +
  geom_line(size = 1.5) +
  geom_point(data = bg_nocomp_rs_plot, aes(x = elevation, y = beta), alpha = 0.5) +
  theme_bw() + scale_color_manual(values = c("orange", "gray47")) +
  ylab("Root distribution parameter") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend("")) +
  theme(legend.position = "top") +
  annotate("text", x = c(0.22, 0.22), y = c(0.95, 0.77), label = c("deeper rooting", "shallower rooting"),color = "gray47", fontface = 3) -> i


beta_finalmod <-lmer(beta ~ age + location + co2 + salinity*elevation_sc +
                    (1 + salinity*elevation_sc| genotype), data = bg_nocomp_rs_plot)

my_labeller <- as_labeller(function(x){
  return(paste0(x))
})

# Make fixed effect plot for age overall
emmip(beta_finalmod, location ~ age, CI = T, weights = "proportional") +
  geom_jitter(data = bg_nocomp_rs_plot, aes(x = age, y = beta, color = location),
              height = 0, width = 0.1, alpha = 0.3, shape = 1) +
  ylab("Root distribution parameter") +
  scale_x_discrete("Age cohort",
                   labels = c("Descendant cohort (2000-2020)" = "Descendant (2000-2020)",
                              "Ancestral cohort (1900-1960)" = "Ancestral (1900-1960)")) +
  scale_color_manual(values = c("#1b9e77", "#7570b3")) + theme_bw() +
  theme(legend.position = "top") + guides(color=guide_legend("")) +
  scale_size_manual(values=c(2,2)) -> j

(i + j) / h + plot_annotation(tag_levels = 'a') -> beta_plot

# Compare to a null model
beta_null_mod <-lm(beta ~ co2 + salinity*elevation_sc, data = bg_nocomp_rs_plot)
beta_null_r2 <- r.squaredGLMM(beta_null_mod)[2]
beta_r2 <- r.squaredGLMM(beta_finalmod)[2]

```

## Average stem height

```{r}
height_mod <- lmer(height_scam_tot ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|site_frame) + (1|genotype), data = bg_nocomp)

plot(height_mod)# Major outlier
bg_nocomp %>% filter(pot_no == 1830)
# This is the outlier and note on data sheet says that this pot had significant
# herbivory which would affect the average height

bg_nocomp_height <- bg_nocomp %>% 
  filter(pot_no != 1830)

height_mod2 <- lmer(height_scam_tot ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|site_frame) + (1|genotype), data = bg_nocomp_height)

# Stepwise selection
#step(height_mod2) # Too complex

VarCorr(height_mod2)
Anova(height_mod2)

# Drop 5-way interaction
height_mod3 <- lmer(height_scam_tot ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^4 + I(elevation_sc^2) +
                  (1|site_frame) + (1|genotype), data = bg_nocomp_height)

#step(height_mod3)
VarCorr(height_mod3)

height_mod4 <- lmer(height_scam_tot ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^4 +
                    +I(elevation_sc^2) + (1|genotype), data = bg_nocomp_height)

step(height_mod4, keep = c("co2", "salinity", "age", "location", "elevation_sc"))

# Fit proposed model from step procedure
height_mod5 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                      (1 | genotype), data = bg_nocomp_height)

# Try fitting additional random slopes
height_mod6 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                    (1+salinity+co2|genotype), data = bg_nocomp_height)
height_mod7 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                    (1+salinity+elevation_sc|genotype), data = bg_nocomp_height) 
height_mod8 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                    (1+elevation_sc+co2|genotype), data = bg_nocomp_height) # fit
height_mod9 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                    (1+co2|genotype), data = bg_nocomp_height) # fit
height_mod10 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                    (1+elevation_sc|genotype), data = bg_nocomp_height) # fit
height_mod11 <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation_sc +
                    (1+salinity|genotype), data = bg_nocomp_height)

anova(height_mod5, height_mod8)
anova(height_mod5, height_mod9) ## This is the best, but not significant
anova(height_mod5, height_mod10)


# Create plot of fixed effects
Anova(height_mod5) # Just elevation really

# Refit so it is not scaled for easy plotting
height_modfinal <- lmer(height_scam_tot ~ date_planted_grp + age + location + co2 + salinity + elevation +
                    (1|genotype), data = bg_nocomp_height)

height_means <- emmeans(height_modfinal, ~elevation, at = list(elevation = seq(min(bg_nocomp_height$elevation), max(bg_nocomp_height$elevation), 0.01)), weights = "proportional")

summary(height_means) %>% 
  ggplot(aes(x = elevation, y = emmean)) +
  geom_line(size = 2) +
  geom_line(aes(x = elevation, y = lower.CL), linetype = "dashed")+
  geom_line(aes(x = elevation, y = upper.CL), linetype = "dashed")+
  geom_point(data = bg_nocomp_height, aes(x = elevation, y = height_scam_tot), alpha = 0.2) +
  ylab("Mean stem height (cm)") +
  xlab("Elevation (m NAVD88)") -> k
  
# Random effects
REsim(height_modfinal) %>%
  mutate(groupID = fct_reorder(groupID, mean)) %>% 
  ggplot(aes(x = groupID)) +
  geom_pointrange(aes(ymin = mean - 2*sd, ymax = mean + 2*sd, xmin = groupID, xmax = groupID, y = mean, color = groupID)) +
  coord_flip() +
  ylab("Random effect") +
  xlab("Genotype") +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() + scale_x_discrete(position = "top") +
  theme(legend.position = "none") +
  scale_color_manual(values = col_vector) -> l

k + l + plot_layout(widths = c(4,1)) +plot_annotation(tag_levels = 'a') -> height_plot

# Fit null model (no age, location or genotype) and compare to height model
height_mod_null <- lm(height_scam_tot ~ date_planted_grp + co2 + salinity + elevation, data = bg_nocomp_height)
height_null_r2 <- r.squaredGLMM(height_mod_null)[2]
height_r2 <- r.squaredGLMM(height_modfinal)[2]
```

## Average stem width

```{r}
width_mod <- lmer(width_scam_mid ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|site_frame) + (1|genotype), data = bg_nocomp)

plot(width_mod)

#step(width_mod, keep = c("co2", "salinity", "elevation_sc", "age", "location"))
summary(width_mod) # site_frame explains nothing

width_mod2 <- lmer(width_scam_mid ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|genotype), data = bg_nocomp)

step(width_mod2, keep = c("co2", "salinity", "elevation_sc", "age", "location"))

# Fit proposed model
width_mod3 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc + (1|genotype), data = bg_nocomp)

# Diagnostic plots
plot_model(width_mod3, type = "diag") # Looks good

# See if we can add any random effects (all additive)

width_mod4 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc +
                     (1+co2+salinity|genotype), data = bg_nocomp) # fits
width_mod5 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc +
                     (1+co2+elevation_sc|genotype), data = bg_nocomp)
width_mod6 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc +
                     (1+salinity+elevation_sc|genotype), data = bg_nocomp) # fits
width_mod7 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc +
                     (1+salinity|genotype), data = bg_nocomp) # fits
width_mod8 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc +
                     (1+elevation_sc|genotype), data = bg_nocomp) # fits
width_mod9 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc +
                     (1+co2|genotype), data = bg_nocomp)

anova(width_mod3, width_mod4)
anova(width_mod3, width_mod6)
anova(width_mod3, width_mod7)
anova(width_mod3, width_mod8)

# None are significant

# Plot the fixed effects
Anova(width_mod3)

# Make fixed effect plot for location by elevation
width_means <- emmeans(width_mod3, ~location:elevation_sc,
                    at= list(elevation_sc = seq(-1.72, 1.54, 0.1)), type = "response")

width_means_out <- summary(width_means)

bg_nocomp_plot %>% 
  mutate(location = case_when(location == "corn" ~ "Corn Island",
                              T ~ "Kirkpatrick Marsh")) -> bg_nocomp_plot

width_means_out %>% 
  mutate(location = case_when(location == "corn" ~ "Corn Island",
                              T ~ "Kirkpatrick Marsh")) %>% 
  mutate(elevation = elevation_sc*scaling + centering) %>% 
  ggplot(aes(x = elevation, y = emmean, color = location)) +
  geom_line(size = 1.5) +
  geom_point(data = bg_nocomp_plot, aes(x = elevation, y = width_scam_mid), alpha = 0.5) +
  theme_bw() + scale_color_manual(values = c("#1b9e77", "#7570b3")) +
  ylab("Mean stem width (mm)") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend("")) +
  theme(legend.position = "top") -> m
  
# Same but for location:salinity interaction
width_mod3 <- lmer(width_scam_mid ~ date_planted_grp + age + co2 +
                     location*salinity + location*elevation_sc + (1|genotype), data = bg_nocomp_plot)

emmip(width_mod3, location ~ salinity, CI = T, weights = "proportional") +
  geom_jitter(data = bg_nocomp_rs_plot, aes(x = salinity, y = width_scam_mid, color = location),
              height = 0, width = 0.1, alpha = 0.3, shape = 1) +
  ylab("Mean stem width (mm)") +
  scale_color_manual(values = c("#1b9e77", "#7570b3")) + theme_bw() +
  theme(legend.position = "top") + guides(color=guide_legend("")) +
  scale_size_manual(values=c(2,2)) -> n
 

# Random effects plot
REsim(width_mod3) %>%
  mutate(groupID = fct_reorder(groupID, mean)) %>% 
  ggplot(aes(x = groupID)) +
  geom_pointrange(aes(ymin = mean - 2*sd, ymax = mean + 2*sd, xmin = groupID, xmax = groupID, y = mean, color = groupID)) +
  coord_flip() +
  ylab("Random effect") +
  xlab("Genotype") +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() + scale_x_discrete(position = "top") +
  theme(legend.position = "none") +
  scale_color_manual(values = col_vector) -> o

mn <- cowplot::plot_grid(m, n, ncol = 1, labels = c("a", "b"))
o_alone <- cowplot::plot_grid(o, labels = c("c"))
mn+o_alone+plot_layout(widths = c(4,1)) -> width_plot

# Fit a model without age, location or genotype
width_mod_null <- lm(width_scam_mid ~ date_planted_grp + co2 +
                     salinity + elevation_sc, data = bg_nocomp_plot)

width_null_r2 <- r.squaredGLMM(width_mod_null)[2]
width_r2 <- r.squaredGLMM(width_mod3)[2]

```

## Belowground biomass

```{r}
bgb_mod <- lmer(total_bg ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|site_frame) + (1|genotype), data = bg_nocomp)

#step(bgb_mod)
VarCorr(bgb_mod)

bgb_mod2 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + location + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|genotype), data = bg_nocomp)

step(bgb_mod2, keep = c("co2", "elevation_sc", "salinity", "age", "location"))

bgb_mod3 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation +
    + location + I(elevation^2) + (1 | genotype) + age*co2*salinity, data = bg_nocomp_plot)

# Diagnostics
plot_model(bgb_mod3, type = "diag") # Pretty!

# Fixed effects plots
car::Anova(bgb_mod3)

bgb_means <- emmeans::emmeans(bgb_mod3, ~co2:salinity:age:elevation, at= list(elevation = seq(0.15, 0.55, 0.01)), type = "response")

bgb_means_out <- summary(bgb_means)

bgb_means_out %>% 
  ggplot(aes(x = elevation, y = emmean, color = co2)) + 
  geom_line(size = 1.5, alpha= 0.8) +
  geom_line(aes(x = elevation, y = lower.CL), linetype = "dashed") + 
  geom_line(aes(x = elevation, y = upper.CL), linetype = "dashed") + 
  facet_grid(age~salinity) +
  geom_point(data = bg_nocomp_plot, aes(x = elevation, y = total_bg), alpha = 0.5) +
  theme_bw() +
  scale_color_manual(values = c("gray47", "#66a61e")) +
  ylab("Belowground biomass (g)") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend(title=expression(CO[2]))) +
  theme(legend.position = "top") -> p

# See if we can add random effects
bgb_mod4 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation_sc + location + I(elevation_sc^2) + (1 + salinity + elevation_sc | genotype) + age*co2*salinity, data = bg_nocomp_plot)
bgb_mod5 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation_sc + location + I(elevation_sc^2) + (1 + co2 + elevation_sc | genotype) + age*co2*salinity, data = bg_nocomp_plot)
bgb_mod6 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation_sc + location + I(elevation_sc^2) + (1 + salinity + co2 | genotype) + age*co2*salinity, data = bg_nocomp_plot)
bgb_mod7 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation_sc + location + I(elevation_sc^2) + (1 + co2 | genotype) + age*co2*salinity, data = bg_nocomp_plot)
bgb_mod8 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation_sc + location + I(elevation_sc^2) + (1 + salinity | genotype) + age*co2*salinity, data = bg_nocomp_plot)
bgb_mod9 <- lmer(total_bg ~ weight_init_sc + date_planted_grp + age + co2 + salinity + elevation_sc + location + I(elevation_sc^2) + (1 + elevation_sc | genotype) + age*co2*salinity, data = bg_nocomp_plot)

# No random slopes

# Create caterpillar graph
REsim(bgb_mod3) %>%
  mutate(groupID = fct_reorder(groupID, mean)) %>% 
  ggplot(aes(x = groupID)) +
  geom_pointrange(aes(ymin = mean - 2*sd, ymax = mean + 2*sd, xmin = groupID, xmax = groupID, y = mean, color = groupID)) +
  coord_flip() +
  ylab("Random effect") +
  xlab("Genotype") +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() + scale_x_discrete(position = "top") +
  theme(legend.position = "none") +
  scale_color_manual(values = col_vector)-> q

p + q + plot_layout(widths = c(4,1)) -> bgb_plot

# Build null model
bgb_null <- lm(total_bg ~ weight_init_sc + date_planted_grp + elevation +
     + I(elevation^2) + co2*salinity, data = bg_nocomp_plot)
bg_null_r2 <- r.squaredGLMM(bgb_null)[2]
bg_r2 <- r.squaredGLMM(bgb_mod3)[2]

```


```{r, fig.align='center', fig.height=7, fig.width=9, echo = F}

agb_plot
rs_plot
bgb_plot
beta_plot
height_plot
width_plot

tibble(trait = c("aboveground biomass", "root-to-shoot ratio", "belowground biomass", "root distribution parameter", "mean stem height", "mean stem width"),
       `null r2` = round(c(agb_null_r2, rs_null_r2, bg_null_r2, beta_null_r2, height_null_r2, width_null_r2),2),
       `evo r2` = round(c(agb_r2, rs_r2, bg_r2, beta_r2, height_r2, width_r2),2)) %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)


```

```{r}
# Show how adding comp fucks things up
bg_corn %>% 
  mutate(elevation_sc = scale(elevation)[,1],
         weight_init_sc = scale(weight_init)[,1]) %>% 
  filter(extinct == 0) %>% 
  mutate(salinity = case_when(salinity == "fresh" ~ "Freshwater Site (6ppt)",
                              T ~ "Brackish Site (8ppt)"),
         age = case_when(age == "modern" ~ "Descendant Cohort (2000-2020)",
                         T ~ "Ancestral Cohort (1900-1960)"))-> bg_corn

# Fit the most complex model -- sqrt of agb biomass seems like the best
# transformation
agb_mod_corn <- lmer(sqrt(agb_scam) ~ weight_init_sc + date_planted_grp + origin_lab +
                  (age + comp + co2 + salinity + elevation_sc)^5 + I(elevation_sc^2) +
                  (1|genotype), data = bg_corn)

step(agb_mod_corn)

# Best model
agb_mod_corn2 <- lmer(sqrt(agb_scam) ~ weight_init_sc +
                  (age + comp + co2 + salinity + elevation)^5 + I(elevation^2) +
                  (1|genotype), data = bg_corn)

agb_means_corn_nocomp <- summary(emmeans::emmeans(agb_mod_corn2, ~co2:salinity:age:elevation:comp, at= list(elevation = seq(0.15, 0.55, 0.01), comp = 0), type = "response"))

agb_means_corn_comp <- summary(emmeans::emmeans(agb_mod_corn2, ~co2:salinity:age:elevation:comp, at= list(elevation = seq(0.15, 0.55, 0.01), comp = 1), type = "response"))

bg_corn_nocomp <- bg_corn %>% filter(comp == 0)
bg_corn_comp <- bg_corn %>% filter(comp == 1)

agb_means_corn_nocomp %>% 
  ggplot(aes(x = elevation, y = response, color = co2)) + 
  geom_line(size = 1.5) +
  geom_line(aes(x = elevation, y = lower.CL), linetype = "dashed") + 
  geom_line(aes(x = elevation, y = upper.CL), linetype = "dashed") + 
  facet_grid(age~salinity) +
  geom_point(data = bg_corn_nocomp, aes(x = elevation, y = agb_scam), alpha = 0.5) +
  theme_bw() +
  scale_color_manual(values = c("gray47", "#66a61e")) +
  ylab("Aboveground biomass (g)") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend(title=expression(CO[2]))) +
  theme(legend.position = "top") -> corn_nocomp

agb_means_corn_comp %>% 
  ggplot(aes(x = elevation, y = response, color = co2)) + 
  geom_line(size = 1.5) +
  geom_line(aes(x = elevation, y = lower.CL), linetype = "dashed") + 
  geom_line(aes(x = elevation, y = upper.CL), linetype = "dashed") + 
  facet_grid(age~salinity) +
  geom_point(data = bg_corn_comp, aes(x = elevation, y = agb_scam), alpha = 0.5) +
  theme_bw() +
  scale_color_manual(values = c("gray47", "#66a61e")) +
  ylab("Aboveground biomass (g)") +
  xlab("Elevation (m NAVD88)") +
  guides(color=guide_legend(title=expression(CO[2]))) +
  theme(legend.position = "top") -> corn_comp

png("~/Documents/BlueGenes/figs/abg_corn_comp.png", height = 7, width = 9, res = 300, units = "in")
corn_comp
dev.off()

```

